package main;
import java.nio.file.Paths;
import java.nio.file.StandardOpenOption;

import javax.imageio.ImageIO;

import java.nio.charset.StandardCharsets;
import java.nio.file.Files;
import java.awt.RenderingHints;
import java.awt.image.BufferedImage;
import java.io.File;

public class ArtModel
{
	private String inputPath;
	private String outputPath;
	private int rewidth;
	private int grayLevel;
	private char writeChar;
	private String stateMessage;
	
	public ArtModel(String inputPath, String outputPath, int rewidth, int grayLevel, char writeChar)
	{
		super();
		this.inputPath = inputPath;
		this.outputPath = outputPath;
		this.rewidth = rewidth;
		this.grayLevel = grayLevel;
		this.writeChar = writeChar;
	}
	
	public String getInputPath()
	{
		return inputPath;
	}

	public void setInputPath(String inputPath)
	{
		this.inputPath = inputPath;
	}

	public String getOutputPath()
	{
		return outputPath;
	}

	public void setOutputPath(String outputPath)
	{
		this.outputPath = outputPath;
	}

	public int getRewidth()
	{
		return rewidth;
	}

	public void setRewidth(int rewidth)
	{
		this.rewidth = rewidth;
	}

	public int getGrayLevel()
	{
		return grayLevel;
	}

	public void setGrayLevel(int grayLevel)
	{
		this.grayLevel = grayLevel;
	}

	public char getWriteChar()
	{
		return writeChar;
	}

	public void setWriteChar(char writeCharacter)
	{
		this.writeChar = writeCharacter;
	}
	
	public String getStateMessage()
	{
		return stateMessage;
	}
	
	/**************************************/
	
	public String Output()
	{
		if (!isPathVaild(inputPath, true))
		{
			return ArtDefiner.INPUT_INVAILD_TEXT;
		}
		
		if (!isPathVaild(outputPath, false))
		{
			return ArtDefiner.OUTPUT_INVAILD_TEXT;
		}
		
		if (rewidth < 0)
		{
			return ArtDefiner.REWIDTH_WIDTH_TEXT;
		}
		
		if (grayLevel < 0 || grayLevel > 255)
		{
			return ArtDefiner.COLOR_RANGE_TEXT;
		}
		
		if (writeChar == ' ')
		{
			return ArtDefiner.CHAR_INVAILD_TEXT;
		}
		
		try
		{
			var fullPath = outputPath + ArtDefiner.OUTPUT_FILE_TEXT;
			var sb = new StringBuilder();
			var imageBuffer = ImageIO.read(new File(inputPath));
			// 創建一個新的 BufferedImage 容納縮小後的圖片
			var resizeImage = new BufferedImage(
				rewidth, 
				getNewSize(imageBuffer.getHeight(), imageBuffer.getWidth(), rewidth),
				imageBuffer.getType()
			);
			
			//獲取 Graphics2D 環境，進行繪製操作
			var graphic = resizeImage.createGraphics();
			//設置渲染提示，讓縮放後的效果更平滑 (抗鋸齒)
			graphic.setRenderingHint(RenderingHints.KEY_INTERPOLATION, RenderingHints.VALUE_INTERPOLATION_BILINEAR);
			//把原始圖片畫在新的縮小圖片上
			graphic.drawImage(imageBuffer, 0, 0, resizeImage.getWidth(), resizeImage.getHeight(), null);
			
			for (var height = 0; height < resizeImage.getHeight(); height++)
			{
				for (var width = 0; width < resizeImage.getWidth(); width++)
				{
					//取得像素顏色
					var colors = resizeImage.getRGB(width, height);
					//轉灰階
					var grayScale = (
							(((colors >> 16) & 0xff) //R
							+ ((colors >> 8) & 0xff) //G
							+ (colors & 0xff)) 		 //B
							/ 3);
					
					if (grayScale < grayLevel)
					{
						sb.append(writeChar);
						//sb.append(' ');
					}
					else
					{
						sb.append(' ');
					}
				}
				
				sb.append(System.lineSeparator());
			}
			
			System.out.println(fullPath);
			Files.write(Paths.get(fullPath), sb.toString().getBytes(StandardCharsets.UTF_8), StandardOpenOption.CREATE);
		}
		catch(Exception e)
		{
			e.printStackTrace();
			return e.toString();
		}
		
		
		return ArtDefiner.OUTPUT_SUCCESS_TEXT + "\n" + outputPath + ArtDefiner.OUTPUT_FILE_TEXT;
	}
	
	private int getNewSize(int targetSide, int adjacentSide, int resizedAdjacentSide)
	{
	    var aspectRatio = (double)targetSide / adjacentSide;
	    return (int)(resizedAdjacentSide * aspectRatio);
	}
	
	private boolean isPathVaild(String pathString, boolean checkFile)
	{
		if (pathString == null)
		{
			System.out.println("string is null");
		}
		
		if (pathString != null && pathString.isEmpty())
		{
			System.out.println("a string is empty");
		}
		
		if (pathString != null && !pathString.isEmpty())
		{
			try
			{				
				var path = Paths.get(pathString);
				if(Files.exists(path))
				{
					if (checkFile)
					{
						if (Files.isRegularFile(path))
						{						
							var pathName = path.getFileName().toString();
							for (var suffix : ArtDefiner.FILENAME_EXTENSIONS)
							{
								if (pathName.contains(suffix))
								{
									return true;
								}
							}
						}
					}
					else
					{
						return Files.isDirectory(path);
					}
				}
			}
			catch(java.nio.file.InvalidPathException e)
			{
				e.printStackTrace();
				return false;
			}
		}
		
		return false;
	}
}
